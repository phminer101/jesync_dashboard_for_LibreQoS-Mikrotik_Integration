{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  {% if filename == 'ShapedDevices.csv' %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold">üìÑ Viewing: ShapedDevices.csv</h5>
    <form method="POST" action="{{ url_for('wipe_file', filename='ShapedDevices.csv') }}" onsubmit="return confirm('Are you sure you want to wipe all data in ShapedDevices.csv?')">
      <button class="btn btn-danger btn-sm">
        <i class="bi bi-trash"></i> Wipe All Data
      </button>
    </form>
  </div>
  {% endif %}

  <div class="d-flex justify-content-end align-items-center flex-wrap gap-2 mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="pollToggle">
      <label class="form-check-label" for="pollToggle">üîÅ Real Time Update </label>
    </div>

    <div class="dropdown">
      <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-gear"></i> Jesync | LibreQoS Services
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow">
        {% for service in ["lqosd", "lqos_node_manager", "lqos_scheduler", "updatecsv", "jesync_dashboard"] %}
        <li class="px-3 py-2">
          <div class="d-flex justify-content-between align-items-center">
            <span>{{ service.replace('.service', '') }}</span>
            <span>
              {% if service_statuses[service] == 'active' %}
                <span class="badge bg-success">‚óè</span>
              {% else %}
                <span class="badge bg-danger">‚óè</span>
              {% endif %}
            </span>
            <form method="POST" action="{{ url_for('restart_specific_service', service=service) }}" class="ms-2">
              <button class="btn btn-sm btn-outline-success" title="Restart">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </form>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="alert alert-info text-center fw-bold" id="totals">
    üî• Total Active Hotspot: ... &nbsp;&nbsp;&nbsp; üì° Total Active PPPoE: ...
  </div>

  <div id="router-cards" class="row g-3 mb-4"></div>

  <!-- üñß Local Server Interface Info -->
  <div class="card border-info mb-4">
    <div class="card-header bg-info text-white fw-bold">üñß Server Ethernet Interfaces</div>
    <div class="card-body" id="local-interfaces">
      Loading...
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100 border-dark shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="bi bi-tools"></i> üîß Jesync Integration Files
        </div>
        <div class="card-body p-0">
          <table class="table table-hover m-0">
            <thead class="text-center">
              <tr><th class="text-start">Filename</th><th>Action</th><th>Backup</th></tr>
            </thead>
            <tbody>
              {% for file in files %}
              {% if file in ["jesync_static_device.json", "config.json", "updatecsv.py", "jesyncmt.json"] %}
              <tr>
                <td class="text-start">{{ file }}</td>
                <td class="text-center">
                  <a href="{{ url_for('edit_file', filename=file) }}" class="btn btn-outline-primary btn-sm" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </a>
                </td>
                <td class="text-center">
                  <form method="POST" action="{{ url_for('backup_file', filename=file) }}" class="d-inline">
                    <button class="btn btn-outline-warning btn-sm" title="Backup">
                      <i class="bi bi-cloud-arrow-down-fill"></i>
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('restore_file', filename=file) }}" class="d-inline">
                    <button class="btn btn-outline-info btn-sm" title="Restore">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 border-primary shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-diagram-3"></i> üìÇ LibreQoS Files
        </div>
        <div class="card-body p-0">
          <table class="table table-hover m-0">
            <thead class="text-center">
              <tr><th class="text-start">Filename</th><th>Action</th><th>Backup</th></tr>
            </thead>
            <tbody>
              {% for file in files %}
              {% if file in ["network.json", "ShapedDevices.csv", "lqos.conf", "updatecsv.service", "50-cloud-init.yaml", "libreqos.yaml"] %}
              <tr>
                <td class="text-start">{{ file }}</td>
                <td class="text-center">
                  {% if file == "ShapedDevices.csv" %}
                    <a href="{{ url_for('edit_file', filename=file) }}" class="btn btn-outline-secondary btn-sm" title="View">
                      <i class="bi bi-eye"></i>
                    </a>
                  {% else %}
                    <a href="{{ url_for('edit_file', filename=file) }}" class="btn btn-outline-primary btn-sm" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
                  {% endif %}
                </td>
                <td class="text-center">
                  <form method="POST" action="{{ url_for('backup_file', filename=file) }}" class="d-inline">
                    <button class="btn btn-outline-warning btn-sm" title="Backup">
                      <i class="bi bi-cloud-arrow-down-fill"></i>
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('restore_file', filename=file) }}" class="d-inline">
                    <button class="btn btn-outline-info btn-sm" title="Restore">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let pollingInterval = null;

  async function fetchActiveSessions() {
    try {
      const res = await fetch("/api/active_sessions");
      const data = await res.json();

      document.getElementById("totals").innerHTML =
        `üî• Total Active Hotspot: ${data.total_hotspot} &nbsp;&nbsp;&nbsp; üì° Total Active PPPoE: ${data.total_pppoe}`;

      const container = document.getElementById("router-cards");
      container.innerHTML = "";

      data.mikrotik_data.forEach(router => {
        const col = document.createElement("div");
        col.className = "col-md-4";

        col.innerHTML = `
          <div class="card border-secondary h-100">
            <div class="card-header bg-secondary text-white fw-bold">
              üì° ${router.name} (${router.address})
            </div>
            <div class="card-body d-flex justify-content-between">
              <span>Hotspot: <strong>${router.hotspot}</strong></span>
              <span>PPPoE: <strong>${router.pppoe}</strong></span>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    } catch (err) {
      console.error("‚ùå Error fetching MikroTik data:", err);
    }
  }

  async function fetchLocalInterfaces() {
    try {
      const res = await fetch("/api/local_interfaces");
      const data = await res.json();

      let html = "";
      Object.entries(data).forEach(([name, val]) => {
        html += `<div>${name}: ${val.status ? 'üü¢ Active' : 'üî¥ Inactive'} (${val.ip})</div>`;
      });

      document.getElementById("local-interfaces").innerHTML = html || "No interfaces found";
    } catch (err) {
      document.getElementById("local-interfaces").innerHTML = "Error loading interface info";
      console.error("Error fetching local interface info:", err);
    }
  }

  function startPolling() {
    if (pollingInterval) return;
    fetchActiveSessions();
    pollingInterval = setInterval(fetchActiveSessions, 10000);
  }

  function stopPolling() {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }

  const pollToggle = document.getElementById("pollToggle");
  pollToggle.addEventListener("change", function () {
    if (this.checked) {
      localStorage.setItem("smartPolling", "enabled");
      startPolling();
    } else {
      localStorage.setItem("smartPolling", "disabled");
      stopPolling();
    }
  });

  window.onload = () => {
    const saved = localStorage.getItem("smartPolling");
    if (saved === "enabled") {
      pollToggle.checked = true;
      startPolling();
    } else {
      fetchActiveSessions();
    }

    fetchLocalInterfaces();
  };
</script>
{% endblock %}
