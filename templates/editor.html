{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h4 class="mb-3">ğŸ“ {{ "Editing" if can_edit else "Viewing" }}: {{ filename }}</h4>

 {% if filename == 'ShapedDevices.csv' %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">ğŸ”„ Refresh</button>
  </div>
  <form method="POST" action="{{ url_for('wipe_file', filename=filename) }}" onsubmit="return confirm('Are you sure you want to wipe all data in ShapedDevices.csv?')">
    <button class="btn btn-sm btn-danger">ğŸ—‘ï¸ Wipe All Data</button>
  </form>
</div>


<form method="POST" action="{{ url_for('upload_csv', filename=filename) }}" enctype="multipart/form-data" class="mb-4">
  <label class="form-label fw-bold">ğŸ“¤ Upload New ShapedDevices.csv:</label>
  <div class="input-group">
    <input type="file" name="csv_file" accept=".csv" class="form-control" required>
    <button type="submit" class="btn btn-outline-success">
      <i class="bi bi-upload"></i> Upload
    </button>
  </div>
  <small class="text-muted">âš ï¸ This will overwrite the current CSV file immediately.</small>
</form>


  <form method="POST" action="{{ url_for('add_shaped_device') }}" class="mb-4">
    <div class="row g-2">
      <div class="col-md-2"><input type="text" class="form-control" name="circuit_id" placeholder="Circuit ID" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="circuit_name" placeholder="Circuit Name" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="device_id" placeholder="Device ID" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="device_name" placeholder="Device Name" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="parent_node" placeholder="Parent Node" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="mac" placeholder="MAC Address"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="ipv4" placeholder="IPv4"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="ipv6" placeholder="IPv6"></div>
      <div class="col-md-2"><input type="number" class="form-control" name="download_min" placeholder="DL Min Mbps"></div>
      <div class="col-md-2"><input type="number" class="form-control" name="upload_min" placeholder="UL Min Mbps"></div>
      <div class="col-md-2"><input type="number" class="form-control" name="download_max" placeholder="DL Max Mbps"></div>
      <div class="col-md-2"><input type="number" class="form-control" name="upload_max" placeholder="UL Max Mbps"></div>
      <div class="col-md-4 mt-2"><input type="text" class="form-control" name="comment" placeholder="Comment"></div>
      <div class="col-md-12 mt-2">
        <button type="submit" class="btn btn-success">â• Add Entry</button>
      </div>
    </div>
  </form>
  {% endif %}

  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-3">â† Back to Home</a>

  {% if can_edit %}
    <form method="POST" action="{{ url_for('backup_file', filename=filename) }}" class="d-inline">
      <button type="submit" class="btn btn-outline-warning mb-3">ğŸ“¦ Backup</button>
    </form>
    <form method="POST" action="{{ url_for('restore_file', filename=filename) }}" class="d-inline">
      <button type="submit" class="btn btn-outline-info mb-3">â™»ï¸ Restore</button>
    </form>
  {% endif %}

  {% if file_type == "csv" %}
    <div class="table-responsive">
      <table id="csvTable" class="table table-bordered table-striped table-sm">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
      const csvContent = `{{ content | replace('\r\n', '\n') | safe }}`;
      const rows = csvContent.trim().split("\n").map(row => row.split(","));
      const table = document.getElementById("csvTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");

      const headerRow = document.createElement("tr");
      rows[0].forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });

      const deleteHeader = document.createElement("th");
      deleteHeader.textContent = "Delete";
      headerRow.appendChild(deleteHeader);
      thead.appendChild(headerRow);

      rows.slice(1).forEach((row, index) => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });

        const deleteTd = document.createElement("td");
        deleteTd.innerHTML = `
          <form method="POST" action="/delete_shaped_device/${index}" onsubmit="return confirm('Are you sure you want to delete this entry?')">
            <button class="btn btn-sm btn-outline-danger">ğŸ—‘</button>
          </form>
        `;
        tr.appendChild(deleteTd);
        tbody.appendChild(tr);
      });

      $(document).ready(function () {
        $('#csvTable').DataTable();
      });
    </script>

  {% elif file_type == "json" %}
    <div id="editorArea" style="height: 600px;"></div>
    {% if can_edit %}
      <button id="saveBtn" class="btn btn-success mt-3">ğŸ’¾ Save</button>
      <div id="status" class="mt-2 text-info fw-bold"></div>
    {% endif %}

    <link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.0/dist/jsoneditor.min.js"></script>

    <script>
      const container = document.getElementById("editorArea");
      const editor = new JSONEditor(container, {
        mode: 'tree',
        modes: ['code', 'tree'],
        mainMenuBar: true
      });

      try {
        editor.set({{ content | safe }});
      } catch (e) {
        editor.set({});
        console.error("Invalid JSON content:", e);
      }

      {% if can_edit %}
      document.getElementById("saveBtn").onclick = () => {
        const updated = editor.get();
        fetch("/api/save/{{ filename }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: JSON.stringify(updated, null, 2) })
        }).then(res => res.json()).then(data => {
          document.getElementById("status").innerText = data.message || "Saved.";
        });
      };
      {% endif %}
    </script>

  {% else %}
    <textarea id="editorArea">{{ content }}</textarea>
    {% if can_edit %}
      <button id="saveBtn" class="btn btn-success mt-3">ğŸ’¾ Save</button>
      <div id="status" class="mt-2 text-info fw-bold"></div>
    {% endif %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/searchcursor.min.js"></script>

    <script>
      const editor = CodeMirror.fromTextArea(document.getElementById("editorArea"), {
        lineNumbers: true,
        mode: "yaml",
        theme: "default"
      });

      {% if can_edit %}
      document.getElementById("saveBtn").onclick = () => {
        fetch("/api/save/{{ filename }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: editor.getValue() })
        }).then(res => res.json()).then(data => {
          document.getElementById("status").innerText = data.message || "Saved.";
        });
      };
      {% endif %}

      function performSearch() {
        const query = document.getElementById("searchInput").value;
        if (!query) return;

        editor.operation(() => {
          const cursor = editor.getSearchCursor(query);
          if (cursor.findNext()) {
            editor.setSelection(cursor.from(), cursor.to());
            editor.scrollIntoView({ from: cursor.from(), to: cursor.to() });
          }
        });
      }
    </script>
  {% endif %}
</div>
{% endblock %}
